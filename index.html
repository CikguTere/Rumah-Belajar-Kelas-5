<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Belajar Kelas 5 SD</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for chat icon and other icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html {
            scroll-behavior: smooth; /* Enables smooth scrolling for anchor links */
        }
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Custom styles for subtle hover effect on nav links */
        nav a {
            position: relative;
            padding-bottom: 4px;
        }
        nav a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            background-color: white;
            transition: width 0.3s ease, left 0.3s ease;
        }
        nav a:hover::after {
            width: 100%;
            left: 0;
        }
        /* Chat button styles */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ffb703;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s ease-in-out;
        }
        .chat-button:hover {
            transform: scale(1.1);
        }

        /* Chat modal styles */
        .chat-modal {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 999;
            transform: scale(0); /* Initially hidden */
            transform-origin: bottom right;
            transition: transform 0.3s ease-in-out;
        }
        .chat-modal.active {
            transform: scale(1);
        }
        @media (max-width: 640px) {
            .chat-modal {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: auto;
                height: auto;
                border-radius: 0;
            }
        }
        .chat-header {
            background-color: #fb8500;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        @media (max-width: 640px) {
            .chat-header {
                border-radius: 0;
            }
        }
        .chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f0f2f5;
        }
        .chat-message {
            display: flex;
            margin-bottom: 10px;
        }
        .chat-message.user {
            justify-content: flex-end;
        }
        .chat-message.ai .message-bubble {
            background-color: #e2e8f0;
            color: #333;
            border-bottom-left-radius: 0;
        }
        .chat-message.user .message-bubble {
            background-color: #ffb703;
            color: white;
            border-bottom-right-radius: 0;
        }
        .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .chat-input {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            outline: none;
        }
        .chat-send-button {
            background-color: #fb8500;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .chat-send-button:hover {
            background-color: #e07400;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #888;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Settings modal styles */
        .settings-modal, .custom-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .settings-modal.active, .custom-input-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .settings-content-wrapper, .custom-input-content { /* New wrapper for conditional content */
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .settings-close-button, .custom-input-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #333;
        }
        .custom-input-content {
            max-width: 400px; /* Smaller for input modal */
        }
        /* Added for nav to be always on top and click-through issues */
        nav {
            position: relative;
            z-index: 20;
        }
    </style>
</head>
<body class="bg-[#fef9ef] min-h-screen flex flex-col">
    <!-- Header Section -->
    <header class="bg-[#ffb703] text-white p-6 text-center shadow-lg rounded-b-xl">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-2 leading-tight">Rumah Belajar Kelas 5 SD</h1>
        <p class="text-lg md:text-xl font-medium">Selamat datang! Ayo mulai petualangan belajarmu dengan cara yang menyenangkan!</p>
    </header>

    <!-- Navigation Bar -->
    <nav class="bg-[#fb8500] flex flex-wrap justify-center py-4 px-2 shadow-md">
        <a id="mapelButton" href="#" class="text-white text-lg font-semibold mx-4 my-2 hover:text-gray-100 transition duration-300 cursor-pointer">Mata Pelajaran</a>
        <a id="tentangButton" href="#" class="text-white text-lg font-semibold mx-4 my-2 hover:text-gray-100 transition duration-300 cursor-pointer">Tentang</a>
        <a id="settingsButton" class="text-white text-lg font-semibold mx-4 my-2 hover:text-gray-100 transition duration-300 cursor-pointer">Pengaturan</a>
        <a id="bantuanButton" href="#" class="text-white text-lg font-semibold mx-4 my-2 hover:text-gray-100 transition duration-300 cursor-pointer">Bantuan</a>
    </nav>

    <!-- Firestore Error Banner (New) -->
    <div id="firestoreErrorBanner" class="hidden fixed top-0 left-0 right-0 p-3 bg-red-600 text-white font-bold text-center z-50">
        <p id="firestoreErrorMessage"></p>
        <button onclick="document.getElementById('firestoreErrorBanner').classList.add('hidden')" class="ml-4 px-2 text-sm bg-red-800 rounded">Tutup</button>
    </div>

    <!-- Main Content Area -->
    <main class="flex-grow p-6">
        <!-- Subject List Section (Initially Visible) -->
        <section id="subjectList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Subject cards will be dynamically loaded here by JavaScript -->
        </section>

        <!-- Chapter List Section (Initially Hidden) -->
        <section id="chapterListContainer" class="hidden">
            <button id="backToSubjectsBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full mb-6 transition duration-300 ease-in-out flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Mata Pelajaran
            </button>
            <h2 id="chapterSubjectTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
            <div id="chapterList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Chapter cards will be dynamically loaded here by JavaScript -->
            </div>
        </section>

        <!-- Material Section (Initially Hidden) -->
        <section id="materialContainer" class="hidden bg-white rounded-xl shadow-md p-6 max-w-4xl mx-auto my-8">
            <button id="backToChaptersFromMaterialBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full mb-6 transition duration-300 ease-in-out flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Bab
            </button>
            <h2 id="materialChapterTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
            
            <div id="materialVideo" class="video-container mb-6">
                <!-- Video iframe will be loaded here -->
            </div>
            <div id="materialAudio" class="mb-6">
                <!-- Audio player will be loaded here -->
            </div>

            <div id="materialContent" class="prose max-w-none text-gray-700 leading-relaxed mb-8">
                <!-- Material content will be loaded here -->
            </div>

            <button id="startQuizFromMaterialBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full w-full transition duration-300 ease-in-out flex items-center justify-center">
                Mulai Kuis <i class="fas fa-play ml-2"></i>
            </button>
        </section>

        <!-- Quiz Section (Initially Hidden) -->
        <section id="quizContainer" class="hidden bg-white rounded-xl shadow-md p-6 max-w-2xl mx-auto my-8">
            <button id="backToMaterialBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full mb-6 transition duration-300 ease-in-out flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Materi
            </button>
            <h2 id="quizChapterTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">Kuis: </h2>

            <div id="quizQuestion" class="mb-6">
                <p class="text-xl font-semibold text-gray-700 mb-4" id="questionText"></p>
                <div id="quizOptions" class="space-y-3">
                    <!-- Quiz options will be dynamically loaded here -->
                </div>
            </div>

            <div id="quizFeedback" class="text-center font-bold text-lg mb-4 hidden"></div>
            <button id="nextQuestionBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full transition duration-300 ease-in-out hidden">
                Selanjutnya <i class="fas fa-arrow-right ml-2"></i>
            </button>
            <button id="viewResultBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full w-full transition duration-300 ease-in-out hidden">
                Lihat Hasil <i class="fas fa-trophy ml-2"></i>
            </button>
            <div id="quizResult" class="text-center text-2xl font-bold mt-8 hidden"></div>
        </section>

        <!-- About Us Section -->
        <section id="tentang" class="bg-white rounded-xl shadow-md p-6 max-w-4xl mx-auto my-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Tentang Rumah Belajar Kelas 5 SD</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed">
                <p class="mb-4">Rumah Belajar Kelas 5 SD adalah platform edukasi interaktif yang dirancang khusus untuk siswa kelas 5 Sekolah Dasar. Kami bertujuan untuk membuat pembelajaran menjadi lebih menyenangkan, mudah diakses, dan efektif.</p>
                <p class="mb-4">Konten kami disesuaikan dengan kurikulum terbaru, mencakup berbagai mata pelajaran penting dengan materi yang jelas, video penjelasan, dan kuis interaktif untuk menguji pemahaman.</p>
                <p class="mb-4">Dengan antarmuka yang ramah pengguna dan fitur-fitur yang menarik, kami berharap dapat membantu setiap siswa meraih potensi terbaiknya dalam belajar. Mari belajar bersama dan raih prestasi!</p>
                <h3 class="text-2xl font-bold text-gray-800 mb-3 mt-6">Tim Kami</h3>
                <p>Kami adalah tim kecil yang bersemangat dalam pendidikan dan teknologi. Kami berkomitmen untuk terus mengembangkan dan memperbarui platform ini agar selalu relevan dan bermanfaat bagi para siswa, guru, dan orang tua.</p>
            </div>
        </section>

        <!-- Help Section -->
        <section id="bantuan" class="bg-white rounded-xl shadow-md p-6 max-w-4xl mx-auto my-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Bantuan & FAQ</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed">
                <p class="mb-4">Selamat datang di halaman bantuan! Di sini Anda akan menemukan informasi umum dan jawaban atas pertanyaan yang sering diajukan.</p>
                
                <h3 class="text-2xl font-bold text-gray-800 mb-3">Bagaimana cara menggunakan aplikasi ini?</h3>
                <p class="mb-4">Cukup klik pada mata pelajaran yang ingin Anda pelajari, lalu pilih babnya. Setiap bab berisi materi pembelajaran dan kuis untuk menguji pemahaman Anda.</p>

                <h3 class="text-2xl font-bold text-gray-800 mb-3">Bagaimana cara mengatur konten?</h3>
                <p class="mb-4">Untuk mengatur konten (menambah, mengedit, menghapus mata pelajaran atau bab), klik tombol "Pengaturan" di navigasi atas. Anda akan diminta untuk memasukkan password. Password default adalah `<span class="font-bold">adminpassword</span>`.</p>

                <h3 class="text-2xl font-bold text-gray-800 mb-3">Bagaimana cara mengubah password pengaturan?</h3>
                <p class="mb-4">Setelah Anda berhasil masuk ke pengaturan, Anda akan menemukan bagian "Ubah Password Pengaturan". Masukkan password lama Anda, lalu masukkan password baru dan konfirmasinya.</p>

                <h3 class="text-2xl font-bold text-gray-800 mb-3">Apakah data saya aman?</h3>
                <p class="mb-4">Aplikasi ini menyimpan data Anda secara lokal di *browser* Anda. Ini berarti data hanya dapat diakses dari *browser* yang sama di perangkat yang sama. Jika Anda menghapus *cache* atau data situs, data Anda mungkin hilang.</p>

                <p class="mt-8 text-center text-gray-600">Jika Anda memiliki pertanyaan lain, silakan gunakan fitur chat dengan Cikgu Tere!</p>
            </div>
        </section>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-300 text-center p-4 mt-auto rounded-t-xl shadow-inner">
        <p class="text-gray-700">&copy; 2025 Rumah Belajar Kelas 5 SD</p>
    </footer>

    <!-- Chat Button -->
    <div id="chatButton" class="chat-button">
        <i class="fas fa-comments"></i>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="chat-modal hidden">
        <div class="chat-header">
            <h3 class="text-xl font-bold">Cikgu Tere</h3>
            <button id="closeChat" class="text-white hover:text-gray-100 text-2xl">&times;</button>
        </div>
        <div id="chatBody" class="chat-body">
            <!-- Chat messages will be appended here -->
            <div class="chat-message ai">
                <div class="message-bubble">Halo! Saya Cikgu Tere. Ada yang bisa saya bantu hari ini?</div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ketik pesan Anda...">
            <button id="sendMessage" class="chat-send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content-wrapper">
            <button id="closeSettings" class="settings-close-button">&times;</button>
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Pengaturan Konten</h2>

            <!-- Password Input Section (Initially Visible if not admin) -->
            <div id="passwordInputSection" class="mb-8 p-4 border border-gray-200 rounded-lg">
                <h3 class="text-2xl font-bold text-gray-700 mb-4">Akses Pengaturan</h3>
                <div class="mb-4">
                    <label for="settingsPasswordEntry" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="settingsPasswordEntry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <button id="submitSettingsPasswordBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md w-full">Masuk</button>
                <p id="authFeedback" class="text-center text-red-600 font-bold mt-4"></p>
            </div>

            <!-- Main Settings Content (Initially Hidden) -->
            <div id="mainSettingsContent" class="hidden">
                <!-- Subject Management -->
                <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Manajemen Mata Pelajaran</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <select id="selectSubjectToEdit" class="flex-grow p-2 border rounded-md"></select>
                        <button id="editSubjectBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Edit Detail Mata Pelajaran</button>
                        <button id="deleteSubjectBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Hapus Mata Pelajaran</button>
                    </div>
                    <button id="addNewSubjectBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md w-full">Tambah Mata Pelajaran Baru</button>
                    
                    <div id="subjectEditForm" class="mt-6 p-4 border border-gray-300 rounded-lg bg-gray-50 hidden">
                        <h4 class="text-xl font-semibold mb-3">Edit Mata Pelajaran</h4>
                        <label for="editSubjectName" class="block text-gray-700 text-sm font-bold mb-2">Nama Mata Pelajaran:</label>
                        <input type="text" id="editSubjectName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                        <label for="editSubjectDescription" class="block text-gray-700 text-sm font-bold mb-2">Deskripsi:</label>
                        <textarea id="editSubjectDescription" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24 mb-4"></textarea>
                        <button id="saveSubjectChangesBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md w-full">Simpan Perubahan Mata Pelajaran</button>
                    </div>
                </div>

                <!-- Chapter Management -->
                <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Manajemen Bab</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <select id="selectSubjectForChapters" class="flex-grow p-2 border rounded-md"></select>
                        <select id="selectChapterToEdit" class="flex-grow p-2 border rounded-md"></select>
                        <button id="editChapterBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Edit Detail Bab</button>
                        <button id="deleteChapterBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Hapus Bab</button>
                    </div>
                    <button id="addNewChapterBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md w-full">Tambah Bab Baru</button>
                    
                    <div id="chapterEditForm" class="mt-6 p-4 border border-gray-300 rounded-lg bg-gray-50 hidden">
                        <h4 class="text-xl font-semibold mb-3">Edit Bab</h4>
                        <label for="editChapterTitle" class="block text-gray-700 text-sm font-bold mb-2">Judul Bab:</label>
                        <input type="text" id="editChapterTitle" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                        <label for="editChapterSummary" class="block text-gray-700 text-sm font-bold mb-2">Ringkasan Materi:</label>
                        <textarea id="editChapterSummary" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24 mb-4"></textarea>
                        <label for="editMaterialContent" class="block text-gray-700 text-sm font-bold mb-2">Konten Materi (Teks/HTML):</label>
                        <textarea id="editMaterialContent" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-48 mb-4"></textarea>
                        <label for="editVideoUrl" class="block text-gray-700 text-sm font-bold mb-2">URL Video YouTube (Direct Link):</label>
                        <input type="text" id="editVideoUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" placeholder="Misal: https://www.youtube.com/watch?v=VIDEO_ID_ANDA">
                        <label for="editAudioUrl" class="block text-gray-700 text-sm font-bold mb-2">URL Audio:</label>
                        <input type="text" id="editAudioUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                        
                        <h4 class="text-xl font-semibold mb-3 mt-6">Edit Kuis</h4>
                        <div id="quizQuestionsEditArea" class="space-y-4">
                            <!-- Quiz questions will be dynamically loaded here -->
                        </div>
                        <button id="addQuizQuestionBtn" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-md mt-4 w-full">Tambah Pertanyaan Kuis</button>
                        <button id="saveChapterChangesBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md w-full mt-6">Simpan Perubahan Bab</button>
                    </div>
                </div>
                
                <!-- Password Management Section -->
                <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Ubah Password Pengaturan</h3>
                    <div class="mb-4">
                        <label for="oldSettingsPasswordInput" class="block text-gray-700 text-sm font-bold mb-2">Password Lama:</label>
                        <input type="password" id="oldSettingsPasswordInput" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="newSettingsPasswordInput" class="block text-gray-700 text-sm font-bold mb-2">Password Baru:</label>
                        <input type="password" id="newSettingsPasswordInput" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-6">
                        <label for="confirmNewSettingsPasswordInput" class="block text-gray-700 text-sm font-bold mb-2">Konfirmasi Password Baru:</label>
                        <input type="password" id="confirmNewSettingsPasswordInput" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button id="saveNewSettingsPasswordBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md w-full">Simpan Password Baru</button>
                    <p id="passwordChangeFeedback" class="text-center text-red-600 font-bold mt-4"></p>
                </div>
            </div> <!-- End of mainSettingsContent -->

        </div> <!-- End of settings-content-wrapper -->
    </div> <!-- End of settingsModal -->

    <!-- Custom Input Modal (New!) -->
    <div id="customInputModal" class="custom-input-modal">
        <div class="custom-input-content">
            <button id="customInputCloseButton" class="custom-input-close-button">&times;</button>
            <h3 id="customInputTitle" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <input type="text" id="customInputField" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" placeholder="">
            <p id="customInputFeedback" class="text-red-600 text-sm mb-4 hidden"></p>
            <div class="flex justify-end gap-4">
                <button id="customInputCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Batal</button>
                <button id="customInputSubmitBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Tambah</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Global Variables (Mandatory) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        let db;
        let auth;
        let userId = 'anonymous'; // Will be updated on auth state change
        let unsubscribeContent = () => {}; // For cleaning up snapshot listeners


        // --- Data Pelajaran, Bab, dan Kuis (Default Structure) ---
        // Data ini mensimulasikan materi dari Capaian Pembelajaran Kurikulum Merdeka Kelas 5 SD.
        const defaultAppData = {
            subjects: [
                { id: 'agama-katolik', name: 'Agama Katolik', description: 'Mengenal Yesus dan hidup Kristiani.' },
                { id: 'pancasila', name: 'Pendidikan Pancasila', description: 'Nilai-nilai kebangsaan dan gotong royong.' },
                { id: 'b-indonesia', name: 'Bahasa Indonesia', description: 'Membaca, menulis, dan bercerita.' },
                { id: 'matematika', name: 'Matematika', description: 'Bilangan, pengukuran, dan bangun ruang.' },
                { id: 'ipas', name: 'IPAS', description: 'Eksperimen sains dan lingkungan sekitar.' },
                { id: 'seni-teater', name: 'Seni Teater', description: 'Bermain peran dan ekspresi diri.' },
                { id: 'b-inggris', name: 'Bahasa Inggris', description: 'Vocabulary dan percakapan dasar.' },
                { id: 'pjok', name: 'PJOK', description: 'Olahraga dan kesehatan tubuh.' }
            ],
            chapters: {
                'agama-katolik': [
                    {
                        id: 'agama-katolik-bab1', title: 'Bab 1: Allah Menciptakan Kita dan Lingkungan',
                        content_summary: 'Mempelajari tentang kebaikan Tuhan dalam menciptakan alam semesta dan isinya, serta bagaimana kita harus menjaganya.',
                        material_content: `<h3 class="text-2xl font-bold text-gray-800 mb-4">Allah Maha Baik, Menciptakan Segalanya</h3><p class="mb-4">Anak-anak, kita semua hidup di dunia yang indah ini. Semua ini sangat menakjubkan, bukan? Siapa yang menciptakan semua ini? Tentu saja, itu adalah <strong>Allah</strong>!</p><h4 class="font-semibold text-xl mb-3">Tanggung Jawab Kita Terhadap Ciptaan Allah</h4><p class="mb-4">Sebagai ciptaan Allah yang paling istimewa, kita, manusia, diberi tugas untuk menjaga dan melestarikan lingkungan.</p>`,
                        video_url: 'S2pE8-r60F8', // Video ID
                        audio_url: '',
                        quiz: [
                            { question: 'Siapakah yang menciptakan alam semesta dan isinya?', options: ['Manusia', 'Hewan', 'Allah', 'Tumbuhan'], correct_answer_index: 2 },
                            { question: 'Apa yang harus kita lakukan terhadap ciptaan Tuhan?', options: ['Merusak', 'Menjaga', 'Mengabaikan', 'Menjual'], correct_answer_index: 1 },
                            { question: 'Mengapa kita perlu menjaga lingkungan?', options: ['Agar bumi cepat rusak', 'Sebagai tanda syukur kepada Allah', 'Agar bisa membuang sampah sembarangan', 'Supaya tidak ada lagi hewan'], correct_answer_index: 1 },
                            { question: 'Contoh cara menjaga lingkungan adalah...', options: ['Menebang pohon sembarangan', 'Membuang sampah di sungai', 'Menanam pohon', 'Membakar hutan'], correct_answer_index: 2 },
                            { question: 'Sebagai ciptaan Allah yang istimewa, manusia diberi tugas untuk...', options: ['Merusak lingkungan', 'Menggunakan sumber daya alam sepuasnya', 'Menjaga dan melestarikan lingkungan', 'Tidak peduli alam'], correct_answer_index: 2 }
                        ]
                    },
                ],
                'pancasila': [
                    {
                        id: 'pancasila-bab1', title: 'Bab 1: Pancasila sebagai Dasar Negara',
                        content_summary: 'Memahami makna dan fungsi Pancasila sebagai dasar negara Republik Indonesia serta lambangnya.',
                        material_content: `<h3 class="text-2xl font-bold text-gray-800 mb-4">Pancasila: Dasar Negara Kita</h3><p class="mb-4"><strong>Pancasila</strong> adalah dasar negara kita. "Panca" berarti lima, dan "Sila" berarti dasar atau prinsip.</p><h4 class="font-semibold text-xl mb-3">Lima Sila Pancasila:</h4><ol class="list-decimal list-inside mb-4 pl-4"><li><strong>Ketuhanan Yang Maha Esa:</strong> ...</li></ol><p class="mb-4">Lambang negara kita adalah <strong>Garuda Pancasila</strong>.</p>`,
                        video_url: 'ZtqS7Xh7hXo', // Video ID
                        audio_url: '',
                        quiz: [
                            { question: 'Apa dasar negara Republik Indonesia?', options: ['UUD 1945', 'Pancasila', 'Bhinneka Tunggal Ika', 'NKRI'], correct_answer_index: 1 },
                            { question: 'Apa lambang negara Indonesia?', options: ['Bendera Merah Putih', 'Garuda Pancasila', 'Peta Indonesia', 'Monas'], correct_answer_index: 1 },
                            { question: 'Berapa jumlah sila dalam Pancasila?', options: ['Tiga', 'Empat', 'Lima', 'Enam'], correct_answer_index: 2 },
                            { question: 'Sila pertama Pancasila berbunyi...', options: ['Keadilan Sosial', 'Persatuan Indonesia', 'Ketuhanan Yang Maha Esa', 'Kerakyatan'], correct_answer_index: 2 },
                            { question: 'Apa arti Bhinneka Tunggal Ika?', options: ['Bersatu kita teguh', 'Berbeda-beda tetapi tetap satu jua', 'Merdeka seutuhnya', 'Indonesia Jaya'], correct_answer_index: 1 }
                        ]
                    },
                ],
                'b-indonesia': [
                    {
                        id: 'b-indonesia-bab1', title: 'Bab 1: Menemukan Ide Pokok',
                        content_summary: 'Belajar cara menemukan gagasan utama atau ide pokok dalam sebuah paragraf atau teks.',
                        material_content: `<h3 class="text-2xl font-bold text-gray-800 mb-4">Apa Itu Ide Pokok?</h3><p class="mb-4">Ide pokok adalah topik utama yang sedang dibicarakan dalam sebuah paragraf.</p><h4 class="font-semibold text-xl mb-3">Cara Menemukan Ide Pokok:</h4><ol class="list-decimal list-inside mb-4 pl-4"><li><strong>Baca seluruh paragraf dengan saksama.</strong></li></ol>`,
                        video_url: 'Zq4D1T1bE2g', // Video ID
                        audio_url: '',
                        quiz: [
                            { question: 'Apa yang dimaksud dengan ide pokok?', options: ['Kalimat pertama', 'Gagasan utama paragraf', 'Penjelasan tambahan', 'Kesimpulan cerita'], correct_answer_index: 1 },
                            { question: 'Dimana biasanya ide pokok ditemukan?', options: ['Hanya di awal paragraf', 'Hanya di akhir paragraf', 'Di awal atau akhir paragraf', 'Di tengah paragraf'], correct_answer_index: 2 },
                            { question: 'Jika sebuah paragraf menjelaskan tentang jenis-jenis bunga, ide pokoknya kemungkinan besar tentang...', options: ['Cara menanam bunga', 'Bunga sebagai hiasan', 'Jenis-jenis bunga', 'Warna-warni bunga'], correct_answer_index: 2 },
                            { question: 'Untuk menemukan ide pokok, kita harus membaca paragraf dengan...', options: ['Cepat', 'Terburu-buru', 'Saksama', 'Tidak peduli'], correct_answer_index: 2 },
                            { question: 'Kalimat yang mewakili seluruh isi paragraf disebut juga...', options: ['Kalimat penjelas', 'Kalimat utama', 'Kalimat tambahan', 'Kalimat penyimpul'], correct_answer_index: 1 }
                        ]
                    },
                ],
                'matematika': [
                    {
                        id: 'matematika-bab1', title: 'Bab 1: Operasi Hitung Pecahan',
                        content_summary: 'Mempelajari penjumlahan, pengurangan, perkalian, dan pembagian pecahan biasa serta campuran.',
                        material_content: `<h3 class="text-2xl font-bold text-gray-800 mb-4">Mari Berhitung Pecahan!</h3><p class="mb-4">Pecahan adalah bagian dari keseluruhan.</p><h4 class="font-semibold text-xl mb-3">1. Penjumlahan dan Pengurangan Pecahan</h4><p class="mb-4">Contoh: $\\frac{1}{2} + \\frac{1}{4} = \\frac{3}{4}$</p>`,
                        video_url: 'fW_D_m-M2uY', // Video ID
                        audio_url: '',
                        quiz: [
                            { question: 'Hasil dari $\\frac{1}{3} + \\frac{1}{6}$ adalah...', options: ['$\\frac{2}{9}$', '$\\frac{2}{6}$', '$\\frac{3}{6}$', '$\\frac{1}{2}$'], correct_answer_index: 3 },
                            { question: 'Berapa hasil dari $\\frac{4}{5} - \\frac{1}{5}$?', options: ['$\\frac{3}{0}$', '$\\frac{3}{5}$', '$\\frac{5}{5}$', '$\\frac{4}{10}$'], correct_answer_index: 1 },
                            { question: 'Hasil dari $\\frac{1}{2} \\times \\frac{3}{4}$ adalah...', options: ['$\\frac{3}{8}$', '$\\frac{4}{6}$', '$\\frac{1}{4}$', '$\\frac{2}{6}$'], correct_answer_index: 0 },
                            { question: 'Berapa hasil dari $\\frac{2}{5} \\div \\frac{1}{3}$?', options: ['$\\frac{2}{15}$', '$\\frac{5}{6}$', '$\\frac{6}{5}$', '$\\frac{1}{2}$'], correct_answer_index: 2 },
                            { question: 'Pecahan $\\frac{3}{4}$ jika diubah ke bentuk desimal menjadi...', options: ['0.34', '0.43', '0.75', '0.25'], correct_answer_index: 2 }
                        ]
                    },
                ],
                'ipas': [
                    {
                        id: 'ipas-bab1', title: 'Bab 1: Rantai Makanan',
                        content_summary: 'Memahami hubungan makan dan dimakan antar makhluk hidup dalam ekosistem.',
                        material_content: `<h3 class="text-2xl font-bold text-gray-800 mb-4">Rantai Makanan: Siapa Makan Siapa?</h3><p class="mb-4">Hubungan makan dan dimakan antar makhluk hidup secara berurutan ini disebut <strong>rantai makanan</strong>.</p><ol class="list-decimal list-inside mb-4 pl-4"><li><strong>Produsen:</strong> Tumbuhan.</li></ol>`,
                        video_url: 'Km1h0xH6Hw8', // Video ID
                        audio_url: '',
                        quiz: [
                            { question: 'Hubungan makan dan dimakan antar makhluk hidup secara berurutan disebut...', options: ['Siklus air', 'Rantai makanan', 'Jaring-jaring makanan', 'Daur hidup'], correct_answer_index: 1 },
                            { question: 'Siapa yang disebut produsen dalam rantai makanan?', options: ['Hewan', 'Tumbuhan', 'Manusia', 'Jamur'], correct_answer_index: 1 },
                            { question: 'Dalam rantai makanan padi -> tikus -> ular -> elang, siapa yang menjadi konsumen tingkat 1?', options: ['Padi', 'Tikus', 'Ular', 'Elang'], correct_answer_index: 1 },
                            { question: 'Organisme yang menguraikan sisa-sisa makhluk hidup yang sudah mati adalah...', options: ['Produsen', 'Konsumen', 'Herbivora', 'Pengurai'], correct_answer_index: 3 },
                            { question: 'Jika tikus musnah dari rantai makanan padi -> tikus -> ular -> elang, apa yang akan terjadi pada ular?', options: ['Populasi ular akan bertambah', 'Ular akan makan padi', 'Populasi ular akan berkurang', 'Ular akan menjadi produsen'], correct_answer_index: 2 }
                        ]
                    },
                ],
            },
            currentView: 'subjects',
            currentSubjectId: null,
            currentChapterId: null,
            currentQuiz: {
                questions: [],
                currentQuestionIndex: 0,
                score: 0
            },
            settingsPassword: 'adminpassword', // Default password for settings
            currentUser: { 
                isSettingsAdmin: false 
            }
        };

        // Initialize with default data structure; this will be overwritten by Firestore
        let appData = defaultAppData;

        // --- DOM Elements ---
        const subjectListSection = document.getElementById('subjectList');
        const chapterListContainer = document.getElementById('chapterListContainer');
        const backToSubjectsBtn = document.getElementById('backToSubjectsBtn');
        const chapterSubjectTitle = document.getElementById('chapterSubjectTitle');
        const chapterList = document.getElementById('chapterList');

        const materialContainer = document.getElementById('materialContainer');
        const backToChaptersFromMaterialBtn = document.getElementById('backToChaptersFromMaterialBtn');
        const materialChapterTitle = document.getElementById('materialChapterTitle');
        const materialVideo = document.getElementById('materialVideo');
        const materialAudio = document.getElementById('materialAudio'); // New audio element
        const materialContent = document.getElementById('materialContent');
        const startQuizFromMaterialBtn = document.getElementById('startQuizFromMaterialBtn');

        const quizContainer = document.getElementById('quizContainer');
        const backToMaterialBtn = document.getElementById('backToMaterialBtn');
        const quizChapterTitle = document.getElementById('quizChapterTitle');
        const quizQuestionSection = document.getElementById('quizQuestion'); // Renamed for clarity
        const questionText = document.getElementById('questionText');
        const quizOptions = document.getElementById('quizOptions');
        const quizFeedback = document.getElementById('quizFeedback');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const viewResultBtn = document.getElementById('viewResultBtn');
        const quizResult = document.getElementById('quizResult');

        // --- Chat Elements ---
        const chatButton = document.getElementById('chatButton');
        const chatModal = document.getElementById('chatModal');
        const closeChatButton = document.getElementById('closeChat');
        const chatBody = document.getElementById('chatBody');
        const chatInput = document.getElementById('chatInput');
        const sendMessageButton = document.getElementById('sendMessage');

        let chatHistory = []; // Stores the conversation history for the AI

        // --- Navigation Buttons (new variables for explicit listeners) ---
        const mapelButton = document.getElementById('mapelButton');
        const tentangButton = document.getElementById('tentangButton');
        const settingsButton = document.getElementById('settingsButton');
        const bantuanButton = document.getElementById('bantuanButton');

        // Added console log to check if settingsButton element is found
        console.log('Settings Button element (initial check):', settingsButton); 

        // --- Settings Elements ---
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsButton = document.getElementById('closeSettings');
        const settingsContentWrapper = document.querySelector('.settings-content-wrapper'); // New wrapper element
        const passwordInputSection = document.getElementById('passwordInputSection');
        const settingsPasswordEntry = document.getElementById('settingsPasswordEntry');
        const submitSettingsPasswordBtn = document.getElementById('submitSettingsPasswordBtn');
        const authFeedback = document.getElementById('authFeedback');
        const mainSettingsContent = document.getElementById('mainSettingsContent'); // Main content of settings modal

        // Subject Management Elements
        const selectSubjectToEdit = document.getElementById('selectSubjectToEdit');
        const editSubjectBtn = document.getElementById('editSubjectBtn');
        const deleteSubjectBtn = document.getElementById('deleteSubjectBtn');
        const addNewSubjectBtn = document.getElementById('addNewSubjectBtn');
        const subjectEditForm = document.getElementById('subjectEditForm');
        const editSubjectName = document.getElementById('editSubjectName');
        const editSubjectDescription = document.getElementById('editSubjectDescription');
        const saveSubjectChangesBtn = document.getElementById('saveSubjectChangesBtn');

        // Chapter Management Elements
        const selectSubjectForChapters = document.getElementById('selectSubjectForChapters');
        const selectChapterToEdit = document.getElementById('selectChapterToEdit');
        const editChapterBtn = document.getElementById('editChapterBtn');
        const deleteChapterBtn = document.getElementById('deleteChapterBtn');
        const addNewChapterBtn = document.getElementById('addNewChapterBtn');
        const chapterEditForm = document.getElementById('chapterEditForm');
        const editChapterTitle = document.getElementById('editChapterTitle');
        const editChapterSummary = document.getElementById('editChapterSummary');
        const editMaterialContent = document.getElementById('editMaterialContent');
        const editVideoUrl = document.getElementById('editVideoUrl');
        const editAudioUrl = document.getElementById('editAudioUrl'); // New audio URL input
        const quizQuestionsEditArea = document.getElementById('quizQuestionsEditArea');
        const addQuizQuestionBtn = document.getElementById('addQuizQuestionBtn'); 
        const saveChapterChangesBtn = document.getElementById('saveChapterChangesBtn');

        // New Password Management Elements
        const oldSettingsPasswordInput = document.getElementById('oldSettingsPasswordInput');
        const newSettingsPasswordInput = document.getElementById('newSettingsPasswordInput');
        const confirmNewSettingsPasswordInput = document.getElementById('confirmNewSettingsPasswordInput');
        const saveNewSettingsPasswordBtn = document.getElementById('saveNewSettingsPasswordBtn');
        const passwordChangeFeedback = document.getElementById('passwordChangeFeedback');

        // --- Custom Input Modal Elements (New!) ---
        const customInputModal = document.getElementById('customInputModal');
        const customInputCloseButton = document.getElementById('customInputCloseButton');
        const customInputTitle = document.getElementById('customInputTitle');
        const customInputField = document.getElementById('customInputField');
        const customInputFeedback = document.getElementById('customInputFeedback');
        const customInputCancelBtn = document.getElementById('customInputCancelBtn');
        const customInputSubmitBtn = document.getElementById('customInputSubmitBtn');
        let customInputCallback = null; // To store the callback function

        // --- Content Sections ---
        const tentangSection = document.getElementById('tentang');
        const bantuanSection = document.getElementById('bantuan');
        
        // New DOM elements for error display
        const firestoreErrorBanner = document.getElementById('firestoreErrorBanner');
        const firestoreErrorMessage = document.getElementById('firestoreErrorMessage');


        // --- Firebase Core Functions ---

        function displayFirestoreError(message) {
            firestoreErrorMessage.textContent = 'ERROR (Perizinan Firestore): ' + message;
            firestoreErrorBanner.classList.remove('hidden');
            // Hide main content when critical error occurs, but allow settings to be accessed for debugging
            subjectListSection.classList.add('hidden');
            chapterListContainer.classList.add('hidden');
            materialContainer.classList.add('hidden');
            quizContainer.classList.add('hidden');
            tentangSection.classList.add('hidden');
            bantuanSection.classList.add('hidden');
        }


        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }
            try {
                // Set Firestore log level to debug for better diagnostics
                setLogLevel('debug'); 
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication logic using provided token or anonymous sign-in
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Set user ID after authentication state is confirmed
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase authenticated. User ID:", userId);
                    } else {
                        console.warn("Firebase authentication state changed: No user.");
                        userId = 'anonymous-' + crypto.randomUUID(); // Use anonymous ID as fallback
                    }
                    startContentListener(); // Start listening for content only after auth is finalized
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        function startContentListener() {
            // Content is stored in the public path for common access: /artifacts/{appId}/public/data/content/{docId}
            const contentDocRef = doc(db, `artifacts/${appId}/public/data/content`, 'master_content');
            
            // Clean up previous listener if any
            unsubscribeContent(); 

            unsubscribeContent = onSnapshot(contentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Real-time content update received from Firestore.");
                    // Overwrite local appData with Firestore data
                    const firestoreData = docSnap.data();
                    firestoreErrorBanner.classList.add('hidden'); // Hide error banner if data received

                    // Merge and ensure required fields are present (safety check)
                    appData = {
                        ...defaultAppData, 
                        ...firestoreData,
                        subjects: firestoreData.subjects || defaultAppData.subjects,
                        chapters: firestoreData.chapters || defaultAppData.chapters,
                        settingsPassword: firestoreData.settingsPassword || defaultAppData.settingsPassword
                    };
                } else {
                    console.log("Content document does not exist. Initializing default data and creating document.");
                    // Create the document with default data if it doesn't exist
                    appData = defaultAppData;
                    setDoc(contentDocRef, appData, { merge: true }).catch(e => console.error("Error setting default content:", e));
                }
                // Re-render the UI based on new data
                renderSubjects(); 
                updateVisibleSection(); // Panggil setelah renderSubjects dan pembaruan data
                // Update settings dropdowns if the modal is currently open
                if (settingsModal.classList.contains('active')) {
                    renderSettingsSubjectSelect(); 
                }
            }, (error) => {
                // Handle permission errors visibly
                if (error.code === 'permission-denied') {
                    displayFirestoreError('Akses Ditolak. Harap pastikan Aturan Keamanan Firestore mengizinkan READ/WRITE untuk jalur konten publik ini (artifacts/{appId}/public/data/content/{dokumen=**}).');
                    console.error("ERROR: Firestore Permission Denied. Check Security Rules:", error);
                } else {
                    displayFirestoreError('Terjadi kesalahan koneksi Firestore. Cek konsol untuk detail.');
                    console.error("Error listening to content changes (using default data):", error);
                }
                // Fallback: use default data if listener fails critically
                appData = defaultAppData;
                renderSubjects();
            });
        }

        // <<< START FIX: Added logging for document path >>>
        async function saveData() {
            if (!db) {
                console.error("Firestore is not initialized. Cannot save data.");
                return false;
            }
            // Use the public document reference for saving
            const contentDocRef = doc(db, `artifacts/${appId}/public/data/content`, 'master_content');
            
            // LOGGING THE DOCUMENT PATH: MUST MATCH SECURITY RULES
            console.log(`[Firestore Save] Attempting to write to path: ${contentDocRef.path}`);
            
            try {
                // Write the entire appData structure to Firestore
                await setDoc(contentDocRef, appData, { merge: true });
                console.log('Data successfully saved to Firestore.');
                return true;
            } catch (error) {
                console.error('Error writing document to Firestore:', error);
                // Display error on the banner for critical issues
                if (error.code === 'permission-denied') {
                    displayFirestoreError('Gagal menyimpan. Izin menulis Firestore Ditolak. Harap periksa kembali Aturan Keamanan Firestore (match /artifacts/{appId}/public/data/{collection}/{document} harus mengizinkan "write").');
                } else {
                    displayFirestoreError('Gagal menyimpan. Kesalahan koneksi/server. Cek konsol.');
                }
                return false;
            }
        }
        // <<< END FIX >>>


        // --- Authentication Functions for Settings ---
        if (settingsButton) { // Ensure button exists before adding listener
            settingsButton.addEventListener('click', () => {
                console.log('Pengaturan button clicked. isSettingsAdmin:', appData.currentUser.isSettingsAdmin); // Debug log
                hideAllSections(); // Hide other main sections when settings is opened

                settingsModal.classList.add('active'); // Always activate the modal wrapper

                if (appData.currentUser.isSettingsAdmin) {
                    passwordInputSection.classList.add('hidden'); // Hide password input if already authenticated
                    mainSettingsContent.classList.remove('hidden'); // Show main settings content
                    renderSettingsSubjectSelect(); // Populate subject dropdowns when opening
                    subjectEditForm.classList.add('hidden'); // Hide forms initially
                    chapterEditForm.classList.add('hidden');
                    passwordChangeFeedback.textContent = ''; // Clear password feedback too
                    oldSettingsPasswordInput.value = '';
                    newSettingsPasswordInput.value = '';
                    confirmNewSettingsPasswordInput.value = '';
                    authFeedback.textContent = ''; // Clear auth feedback on re-open
                } else {
                    passwordInputSection.classList.remove('hidden'); // Show password input
                    mainSettingsContent.classList.add('hidden'); // Hide main settings content
                    settingsPasswordEntry.value = ''; // Clear password field
                    settingsPasswordEntry.focus(); // Focus on password input
                    authFeedback.textContent = ''; // Clear previous authentication feedback
                }
            });
        } else {
            console.error('Settings button element not found!');
        }

        // Handle password submission for settings access
        submitSettingsPasswordBtn.addEventListener('click', () => {
            const enteredPassword = settingsPasswordEntry.value;
            authFeedback.classList.remove('text-green-600', 'text-red-600'); // Reset feedback color

            if (enteredPassword === appData.settingsPassword) {
                appData.currentUser.isSettingsAdmin = true;
                passwordInputSection.classList.add('hidden'); // Hide password input
                mainSettingsContent.classList.remove('hidden'); // Show main settings content
                renderSettingsSubjectSelect();
                subjectEditForm.classList.add('hidden');
                chapterEditForm.classList.add('hidden');
                authFeedback.textContent = 'Akses pengaturan berhasil dibuka!'; // Display feedback
                authFeedback.classList.add('text-green-600');
                passwordChangeFeedback.textContent = ''; // Clear password feedback for the change section
            } else {
                authFeedback.textContent = 'Password salah. Akses ditolak.'; // Display feedback
                authFeedback.classList.add('text-red-600');
                settingsPasswordEntry.value = ''; // Clear password field
                settingsPasswordEntry.focus(); // Re-focus for retry
            }
        });

        // Allow 'Enter' key to submit password
        settingsPasswordEntry.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                submitSettingsPasswordBtn.click();
            }
        });


        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            appData.currentUser.isSettingsAdmin = false; // Revoke settings admin access on close
            // No need to call saveData() here, as changes should have been saved immediately after edit
        });

        saveNewSettingsPasswordBtn.addEventListener('click', async () => { // <<< FIX: Made async
            const oldPass = oldSettingsPasswordInput.value;
            const newPass = newSettingsPasswordInput.value;
            const confirmNewPass = confirmNewSettingsPasswordInput.value;

            passwordChangeFeedback.classList.remove('text-green-600', 'text-red-600'); // Reset feedback color

            if (oldPass === '') {
                passwordChangeFeedback.textContent = 'Password lama tidak boleh kosong.';
                passwordChangeFeedback.classList.add('text-red-600');
                return;
            }

            if (newPass === '') {
                passwordChangeFeedback.textContent = 'Password baru tidak boleh kosong.';
                passwordChangeFeedback.classList.add('text-red-600');
                return;
            }

            if (oldPass !== appData.settingsPassword) {
                passwordChangeFeedback.textContent = 'Password lama salah.';
                passwordChangeFeedback.classList.add('text-red-600');
                return;
            }

            if (newPass !== confirmNewPass) {
                passwordChangeFeedback.textContent = 'Password baru dan konfirmasi tidak cocok.';
                passwordChangeFeedback.classList.add('text-red-600');
                return;
            }

            appData.settingsPassword = newPass;
            
            const saveSuccess = await saveData(); // <<< FIX: Await save status

            if (saveSuccess) {
                passwordChangeFeedback.textContent = 'Password pengaturan berhasil diubah dan disimpan online!';
                passwordChangeFeedback.classList.add('text-green-600');
                // Clear fields after successful change
                oldSettingsPasswordInput.value = '';
                newSettingsPasswordInput.value = '';
                confirmNewSettingsPasswordInput.value = '';
            } else {
                passwordChangeFeedback.textContent = 'Gagal menyimpan password baru secara online. Periksa konsol dan Aturan Keamanan Firestore.';
                passwordChangeFeedback.classList.add('text-red-600');
            }
        });


        // --- Fungsi Navigasi & Render ---

        // Helper function to hide all main sections
        function hideAllSections() {
            subjectListSection.classList.add('hidden');
            chapterListContainer.classList.add('hidden');
            materialContainer.classList.add('hidden');
            quizContainer.classList.add('hidden');
            tentangSection.classList.add('hidden'); // Hide about section
            bantuanSection.classList.add('hidden'); // Hide help section
        }

        // New function: Manages which section is visible based on appData.currentView
        function updateVisibleSection() {
            hideAllSections();
            switch (appData.currentView) {
                case 'subjects':
                    subjectListSection.classList.remove('hidden');
                    break;
                case 'chapters':
                    chapterListContainer.classList.remove('hidden');
                    break;
                case 'material':
                    materialContainer.classList.remove('hidden');
                    break;
                case 'quiz':
                    quizContainer.classList.remove('hidden');
                    break;
                case 'tentang':
                    tentangSection.classList.remove('hidden');
                    break;
                case 'bantuan':
                    bantuanSection.classList.remove('hidden');
                    break;
            }
        }


        // Menampilkan daftar mata pelajaran
        function renderSubjects() {
            // Re-render the content based on current data
            subjectListSection.innerHTML = ''; // Clear previous content
            appData.subjects.forEach(subject => {
                const subjectDiv = document.createElement('div');
                subjectDiv.classList.add('subject', 'bg-white', 'rounded-xl', 'shadow-md', 'p-6', 'text-center', 'transform', 'hover:scale-105', 'transition', 'duration-300', 'ease-in-out', 'border', 'border-gray-100', 'cursor-pointer');
                subjectDiv.innerHTML = `
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">${subject.name}</h3>
                    <p class="text-gray-600">${subject.description}</p>
                `;
                subjectDiv.addEventListener('click', () => {
                    appData.currentView = 'chapters'; // Update view state
                    renderChapters(subject.id);
                    updateVisibleSection(); // Show the new chapters view
                });
                subjectListSection.appendChild(subjectDiv);
            });
            // visibility is now handled by updateVisibleSection()
        }

        // Menampilkan daftar bab untuk mata pelajaran tertentu
        function renderChapters(subjectId) {
            appData.currentView = 'chapters';
            appData.currentSubjectId = subjectId; // Save current subject for navigation

            chapterList.innerHTML = ''; // Clear previous content

            const selectedSubject = appData.subjects.find(s => s.id === subjectId);
            chapterSubjectTitle.textContent = `Bab-bab ${selectedSubject ? selectedSubject.name : ''}`;
            
            const chaptersForSubject = appData.chapters[subjectId] || [];
            if (chaptersForSubject.length === 0) {
                chapterList.innerHTML = '<p class="text-center text-gray-600 col-span-full">Belum ada bab untuk mata pelajaran ini.</p>';
                return;
            }

            chaptersForSubject.forEach(chapter => {
                const chapterDiv = document.createElement('div');
                chapterDiv.classList.add('bg-white', 'rounded-xl', 'shadow-md', 'p-6', 'text-center', 'transform', 'hover:scale-105', 'transition', 'duration-300', 'ease-in-out', 'border', 'border-gray-100', 'cursor-pointer');
                chapterDiv.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${chapter.title}</h3>
                    <p class="text-gray-600 text-sm mb-4">${chapter.content_summary}</p>
                    <button class="read-material-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full">
                        Baca Materi <i class="fas fa-book-open ml-2"></i>
                    </button>
                `;
                chapterDiv.querySelector('.read-material-btn').addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent chapterDiv click from firing
                    appData.currentView = 'material';
                    showChapterDetails(chapter.id);
                    updateVisibleSection(); // Show the material view
                });
                chapterList.appendChild(chapterDiv);
            });
        }

        // Menampilkan detail materi dan video untuk bab tertentu
        function showChapterDetails(chapterId) {
            appData.currentView = 'material';
            appData.currentChapterId = chapterId; // Save current chapter for navigation

            const selectedSubject = appData.subjects.find(s => s.id === appData.currentSubjectId);
            const selectedChapter = appData.chapters[appData.currentSubjectId].find(c => c.id === chapterId);

            if (!selectedChapter) {
                // Handle case where chapter not found (shouldn't happen with correct data)
                console.error('Chapter not found:', chapterId);
                renderChapters(appData.currentSubjectId); // Go back to chapters list
                return;
            }

            materialChapterTitle.textContent = `${selectedSubject ? selectedSubject.name : ''} - ${selectedChapter.title}`;
            materialContent.innerHTML = selectedChapter.material_content;
            
            // Embed YouTube video using the extracted video ID
            if (selectedChapter.video_url) {
                // video_url is stored as the video ID
                const videoId = selectedChapter.video_url; 
                materialVideo.innerHTML = `
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        class="w-full h-full rounded-xl"
                    ></iframe>
                `;
            } else {
                materialVideo.innerHTML = `<img src="https://placehold.co/400x225/E0F2FE/3B82F6?text=Video+Materi+Tidak+Tersedia" alt="Video Placeholder" class="w-full h-full object-cover rounded-xl">`;
            }

            // Embed Audio
            if (selectedChapter.audio_url) {
                materialAudio.innerHTML = `
                    <audio controls class="w-full">
                        <source src="${selectedChapter.audio_url}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                `;
            } else {
                materialAudio.innerHTML = ''; // Clear audio if not present
            }

            // Set up "Mulai Kuis" button
            startQuizFromMaterialBtn.onclick = () => {
                appData.currentView = 'quiz';
                startQuiz(chapterId);
                updateVisibleSection(); // Show quiz view
            };
        }

        // Memulai kuis untuk bab tertentu
        function startQuiz(chapterId) {
            appData.currentView = 'quiz';

            const selectedSubject = appData.subjects.find(s => s.id === appData.currentSubjectId);
            const selectedChapter = appData.chapters[appData.currentSubjectId].find(c => c.id === chapterId);

            quizChapterTitle.textContent = `Kuis: ${selectedSubject ? selectedSubject.name : ''} - ${selectedChapter ? selectedChapter.title : ''}`;
            
            appData.currentQuiz.questions = selectedChapter.quiz;
            appData.currentQuiz.currentQuestionIndex = 0;
            appData.currentQuiz.score = 0;

            // Reset quiz display
            quizFeedback.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            viewResultBtn.classList.add('hidden');
            quizResult.classList.add('hidden');
            quizResult.textContent = ''; // Clear previous results
            quizQuestionSection.classList.remove('hidden'); // Ensure question section is visible

            displayQuestion();
        }

        // Menampilkan pertanyaan kuis
        function displayQuestion() {
            const currentQ = appData.currentQuiz.questions[appData.currentQuiz.currentQuestionIndex];
            questionText.innerHTML = `<span class="font-bold">Soal ${appData.currentQuiz.currentQuestionIndex + 1}/${appData.currentQuiz.questions.length}:</span> ${currentQ.question}`;
            quizOptions.innerHTML = ''; // Clear previous options

            currentQ.options.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.classList.add('w-full', 'py-3', 'px-4', 'bg-gray-100', 'text-gray-800', 'rounded-lg', 'text-left', 'hover:bg-gray-200', 'transition', 'duration-200', 'border', 'border-gray-200');
                optionButton.textContent = option;
                optionButton.dataset.index = index;
                optionButton.addEventListener('click', () => checkAnswer(index));
                quizOptions.appendChild(optionButton);
            });

            // Hide next/result buttons until an answer is selected
            nextQuestionBtn.classList.add('hidden');
            viewResultBtn.classList.add('hidden');
            quizFeedback.classList.add('hidden');

            // Enable all options
            Array.from(quizOptions.children).forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('bg-green-200', 'bg-red-200', 'border-green-500', 'border-red-500');
            });
        }

        // Memeriksa jawaban kuis
        function checkAnswer(selectedIndex) {
            const currentQ = appData.currentQuiz.questions[appData.currentQuiz.currentQuestionIndex];
            const correctIndex = currentQ.correct_answer_index;
            const allOptions = Array.from(quizOptions.children);

            // Disable all options after selection
            allOptions.forEach(btn => btn.disabled = true);

            if (selectedIndex === correctIndex) {
                appData.currentQuiz.score++;
                quizFeedback.textContent = 'Benar! ';
                quizFeedback.classList.remove('text-red-600');
                quizFeedback.classList.add('text-green-600');
                allOptions[selectedIndex].classList.add('bg-green-200', 'border-green-500');
            } else {
                quizFeedback.textContent = `Salah. Jawaban yang benar adalah: ${currentQ.options[correctIndex]}`;
                quizFeedback.classList.remove('text-green-600');
                quizFeedback.classList.add('text-red-600');
                allOptions[selectedIndex].classList.add('bg-red-200', 'border-red-500');
                allOptions[correctIndex].classList.add('bg-green-200', 'border-green-500'); // Highlight correct answer
            }
            quizFeedback.classList.remove('hidden');

            // Show next or view result button
            if (appData.currentQuiz.currentQuestionIndex < appData.currentQuiz.questions.length - 1) {
                nextQuestionBtn.classList.remove('hidden');
            } else {
                viewResultBtn.classList.remove('hidden');
            }
        }

        // Melanjutkan ke pertanyaan berikutnya
        nextQuestionBtn.addEventListener('click', () => {
            appData.currentQuiz.currentQuestionIndex++;
            displayQuestion();
        });

        // Menampilkan hasil kuis
        viewResultBtn.addEventListener('click', () => {
            quizQuestionSection.classList.add('hidden');
            quizFeedback.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            viewResultBtn.classList.add('hidden');

            quizResult.textContent = `Skor Anda: ${appData.currentQuiz.score} dari ${appData.currentQuiz.questions.length}`;
            quizResult.classList.remove('hidden');
        });


        // --- Event Listeners Navigasi ---
        // FIX: Added renderSubjects() call to ensure subject cards are redrawn with new data
        backToSubjectsBtn.addEventListener('click', () => {
            appData.currentView = 'subjects';
            renderSubjects(); 
            updateVisibleSection();
        });

        // FIX: Added renderChapters() call for consistency and immediate content update
        backToChaptersFromMaterialBtn.addEventListener('click', () => {
            appData.currentView = 'chapters';
            renderChapters(appData.currentSubjectId); 
            updateVisibleSection();
        });
        
        backToMaterialBtn.addEventListener('click', () => {
            appData.currentView = 'material';
            updateVisibleSection();
        });

        // Event listeners for top navigation buttons
        mapelButton.addEventListener('click', (event) => {
            event.preventDefault();
            appData.currentView = 'subjects';
            renderSubjects(); // Re-render cards
            updateVisibleSection();
            document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
        });

        tentangButton.addEventListener('click', (event) => {
            event.preventDefault();
            appData.currentView = 'tentang';
            updateVisibleSection();
            tentangSection.scrollIntoView({ behavior: 'smooth' });
        });

        bantuanButton.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default anchor link behavior initially
            appData.currentView = 'bantuan';
            updateVisibleSection();
            // Smooth scroll to the help section if it's not at the top of the viewport
            bantuanSection.scrollIntoView({ behavior: 'smooth' });
        });


        // --- Chat Functionality (Existing) ---
        // Fungsi untuk membuka/menutup modal chat
        chatButton.addEventListener('click', () => {
            chatModal.classList.toggle('active');
            chatModal.classList.toggle('hidden');
            if (chatModal.classList.contains('active')) {
                chatInput.focus();
            }
        });

        closeChatButton.addEventListener('click', () => {
            chatModal.classList.remove('active');
            chatModal.classList.add('hidden');
        });

        // Fungsi untuk menambahkan pesan ke tampilan chat
        function addMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Fungsi untuk menampilkan/menyembunyikan indikator mengetik
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.classList.add('chat-message', 'ai', 'typing-indicator');
            typingDiv.innerHTML = `<div class="message-bubble"><span></span><span></span><span></span></div>`;
            chatBody.appendChild(typingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Fungsi untuk mengekstrak ID video YouTube dari berbagai format URL
        function getYouTubeVideoId(url) {
            let videoId = '';
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = url.match(youtubeRegex);
            if (match && match[1]) {
                videoId = match[1];
            }
            return videoId;
        }
        
        // --- Fungsi Helper untuk Fetch dengan Exponential Backoff (Coba Ulang) ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.ok) {
                        return response; // Sukses, langsung kembalikan
                    }

                    // Logika Exponential Backoff untuk error Quota (429) atau Server (5xx)
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s, 8s, 16s
                        console.warn(`[API] Quota limit/Server error (${response.status}). Mencoba ulang dalam ${delay / 1000}s. Percobaan ${attempt + 1}/${maxRetries}`);
                        
                        if (attempt < maxRetries - 1) {
                            // Hanya tunggu jika ini bukan percobaan terakhir
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Lanjutkan ke percobaan berikutnya
                        } else {
                            // Jika sudah mencapai batas percobaan, kembalikan respons error
                            return response;
                        }
                    }
                    
                    // Jika error adalah non-retryable (misal 400 Bad Request/API Key Invalid), langsung kembalikan
                    return response;

                } catch (error) {
                    console.error(`[API] Percobaan fetch ${attempt + 1} gagal (Jaringan):`, error);
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error("Gagal terhubung setelah percobaan maksimum.");
                    }
                }
            }
            throw new Error("Batasan percobaan maksimum terlampaui.");
        }


        // Fungsi untuk mengirim pesan ke AI
        async function sendToAI(prompt) {
            // Kunci API harus diisi dari luar lingkungan hosting (misalnya, di GitHub Pages).
            // Di lingkungan Canvas, kunci akan disediakan secara otomatis.
            const apiKey = "AIzaSyBdiX0pSBrxiR3xeraFi0mrBBHsovXDow0"; // Ganti dengan kunci API Anda yang valid saat hosting di luar Canvas!

            if (apiKey.trim() === "AIzaSyBdiX0pSBrxiR3xeraFi0mrBBHsovXDow0" || apiKey.trim() === "") { 
                hideTypingIndicator();
                addMessage('ai', 'Maaf, kunci API Gemini belum diatur atau salah. Mohon masukkan kunci API Anda yang valid.');
                console.error('ERROR: Kunci API Gemini belum diatur atau masih kosong.');
                return; // Hentikan eksekusi jika kunci API tidak valid
            }
            // *** AKHIR KONFIGURASI KUNCI API ***

            showTypingIndicator();
            addMessage('user', prompt);

            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                // Gunakan fetchWithRetry untuk mencoba beberapa kali jika terjadi error kuota/server
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Cek jika respons HTTP tidak OK (misalnya 400 Bad Request, 401 Unauthorized, atau 429 setelah retry)
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response (Final):', errorData);
                    hideTypingIndicator();
                    addMessage('ai', `Maaf, terjadi masalah saat menghubungi Cikgu Tere. Status: ${response.status}. Detail: ${errorData.error ? errorData.error.message : 'Silakan coba lagi nanti.'}`);
                    return;
                }

                const result = await response.json();
                hideTypingIndicator();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addMessage('ai', aiResponse);
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    addMessage('ai', 'Maaf, Cikgu Tere tidak dapat menghasilkan respons yang valid. Silakan coba pertanyaan lain.');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                hideTypingIndicator();
                addMessage('ai', 'Maaf, terjadi kesalahan jaringan atau teknis setelah percobaan maksimum.');
            }
        }

        sendMessageButton.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                sendToAI(message);
                chatInput.value = '';
            }
        });

        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessageButton.click();
            }
        });

        // Initial message from Cikgu Tere when the chat opens
        if (chatHistory.length === 0) { // Only add initial message if chat history is empty
            chatHistory.push({ role: "model", parts: [{ text: "Halo! Saya Cikgu Tere. Ada yang bisa saya bantu hari ini?" }] });
        }


        // --- Settings Functionality ---

        // Open/Close Settings Modal
        // Note: The settingsButton's click listener is now handled above for password protection.
        // This is the common close logic.
        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            appData.currentUser.isSettingsAdmin = false; // Revoke settings admin access on close
            // No need to call saveData() here, as changes should have been saved immediately after edit
        });

        // Populate Subject dropdowns in settings
        function renderSettingsSubjectSelect() {
            selectSubjectToEdit.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            selectSubjectForChapters.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            appData.subjects.forEach(subject => {
                const option1 = document.createElement('option');
                option1.value = subject.id;
                option1.textContent = subject.name;
                selectSubjectToEdit.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = subject.id;
                option2.textContent = subject.name;
                selectSubjectForChapters.appendChild(option2);
            });
            // Reset chapter dropdown
            selectChapterToEdit.innerHTML = '<option value="">Pilih Bab</option>';
        }

        // Handle subject selection to populate chapter dropdown
        selectSubjectForChapters.addEventListener('change', (event) => {
            const subjectId = event.target.value;
            selectChapterToEdit.innerHTML = '<option value="">Pilih Bab</option>'; // Clear existing options
            chapterEditForm.classList.add('hidden'); // Hide chapter edit form

            if (subjectId && appData.chapters[subjectId]) {
                appData.chapters[subjectId].forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter.id;
                    option.textContent = chapter.title;
                    selectChapterToEdit.appendChild(option);
                });
            }
        });

        // Edit Subject
        editSubjectBtn.addEventListener('click', () => {
            const subjectId = selectSubjectToEdit.value;
            if (!subjectId) {
                // Display feedback directly within the settings modal, not in main settingsFeedback
                authFeedback.textContent = 'Pilih mata pelajaran untuk diedit.'; // Using authFeedback for general settings errors now
                authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                return;
            }
            authFeedback.textContent = ''; // Clear auth feedback when a valid action starts
            const subject = appData.subjects.find(s => s.id === subjectId);
            if (subject) {
                editSubjectName.value = subject.name;
                editSubjectDescription.value = subject.description;
                subjectEditForm.dataset.subjectId = subject.id; // Store ID for saving
                subjectEditForm.classList.remove('hidden');
                chapterEditForm.classList.add('hidden'); // Hide chapter form if subject is edited
            }
        });

        // Save Subject Changes
        saveSubjectChangesBtn.addEventListener('click', async () => { // <<< FIX: Made async
            const subjectId = subjectEditForm.dataset.subjectId;
            const newName = editSubjectName.value.trim();
            const newDescription = editSubjectDescription.value.trim();

            if (!newName) {
                authFeedback.textContent = 'Nama mata pelajaran tidak boleh kosong.';
                authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                return;
            }

            const subjectIndex = appData.subjects.findIndex(s => s.id === subjectId);
            if (subjectIndex !== -1) {
                appData.subjects[subjectIndex].name = newName;
                appData.subjects[subjectIndex].description = newDescription;
                
                const saveSuccess = await saveData(); // <<< FIX: Await save status

                if (saveSuccess) {
                    renderSettingsSubjectSelect(); // Refresh dropdowns
                    renderSubjects(); // Re-render main subject list
                    authFeedback.textContent = 'Mata pelajaran berhasil diperbarui dan tersimpan online!';
                    authFeedback.className = 'text-center text-green-600 font-bold mt-4';
                    subjectEditForm.classList.add('hidden');
                } else {
                    authFeedback.textContent = 'Gagal menyimpan perubahan mata pelajaran secara online. Periksa Aturan Keamanan Firestore.';
                    authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                }
            }
        });

        // Delete Subject
        deleteSubjectBtn.addEventListener('click', async () => { // <<< FIX: Made async
            const subjectId = selectSubjectToEdit.value;
            if (!subjectId) {
                authFeedback.textContent = 'Pilih mata pelajaran untuk dihapus.';
                authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                return;
            }
            if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini beserta semua babnya?')) {
                appData.subjects = appData.subjects.filter(s => s.id !== subjectId);
                delete appData.chapters[subjectId]; // Delete associated chapters
                
                const saveSuccess = await saveData(); // <<< FIX: Await save status

                if (saveSuccess) {
                    renderSettingsSubjectSelect();
                    renderSubjects(); // Re-render main subject list
                    authFeedback.textContent = 'Mata pelajaran berhasil dihapus dan tersimpan online!';
                    authFeedback.className = 'text-center text-green-600 font-bold mt-4';
                    subjectEditForm.classList.add('hidden');
                } else {
                    authFeedback.textContent = 'Gagal menghapus mata pelajaran secara online. Periksa Aturan Keamanan Firestore.';
                    authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                }
            }
        });

        // Add New Subject (Now uses custom modal)
        addNewSubjectBtn.addEventListener('click', () => {
            console.log('addNewSubjectBtn clicked. Showing custom input modal.');
            showCustomInputModal('Tambah Mata Pelajaran Baru', 'Masukkan nama mata pelajaran baru...', async (newSubjectName) => { // <<< FIX: Made async
                if (newSubjectName && newSubjectName.trim() !== '') {
                    const newSubjectId = newSubjectName.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, ''); // Simple ID generation
                    if (appData.subjects.some(s => s.id === newSubjectId)) {
                        customInputFeedback.textContent = 'Mata pelajaran dengan nama ini sudah ada.';
                        customInputFeedback.classList.remove('hidden');
                        return false; // Keep modal open
                    }
                    appData.subjects.push({
                        id: newSubjectId,
                        name: newSubjectName.trim(),
                        description: 'Deskripsi mata pelajaran baru.'
                    });
                    appData.chapters[newSubjectId] = []; // Initialize empty chapters array
                    
                    const saveSuccess = await saveData(); // <<< FIX: Await save status

                    if (saveSuccess) {
                        renderSettingsSubjectSelect();
                        renderSubjects();
                        authFeedback.textContent = 'Mata pelajaran baru berhasil ditambahkan dan tersimpan online!';
                        authFeedback.className = 'text-center text-green-600 font-bold mt-4';
                        console.log('New subject added successfully:', newSubjectId);
                        return true; // Close modal
                    } else {
                        authFeedback.textContent = 'Gagal menambah mata pelajaran baru secara online. Periksa Aturan Keamanan Firestore.';
                        authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                        // Revert the local change if save fails to avoid desync
                        appData.subjects.pop(); 
                        delete appData.chapters[newSubjectId];
                        return false; // Keep modal open or prompt user to retry
                    }
                } else {
                    customInputFeedback.textContent = 'Judul tidak boleh kosong.';
                    customInputFeedback.classList.remove('hidden');
                    console.log('New subject creation cancelled or empty title.');
                    return false; // Keep modal open
                }
            });
        });

        // Edit Chapter
        editChapterBtn.addEventListener('click', () => {
            const subjectId = selectSubjectForChapters.value;
            const chapterId = selectChapterToEdit.value;

            if (!subjectId || !chapterId) {
                authFeedback.textContent = 'Pilih mata pelajaran dan bab untuk diedit.';
                authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                return;
            }
            authFeedback.textContent = '';
            const chapter = appData.chapters[subjectId].find(c => c.id === chapterId);
            if (chapter) {
                editChapterTitle.value = chapter.title;
                editChapterSummary.value = chapter.content_summary;
                editMaterialContent.value = chapter.material_content;
                // Convert stored video ID back to a direct YouTube link for display in the input field
                editVideoUrl.value = chapter.video_url ? `https://www.youtube.com/watch?v=${chapter.video_url}` : '';
                editAudioUrl.value = chapter.audio_url; // Set audio URL
                chapterEditForm.dataset.subjectId = subjectId;
                chapterEditForm.dataset.chapterId = chapterId;
                chapterEditForm.classList.remove('hidden');
                subjectEditForm.classList.add('hidden'); // Hide subject form if chapter is edited
                renderQuizEdit(chapter.quiz);
            }
        });

        // Render Quiz Questions for Editing
        function renderQuizEdit(quizArray) {
            quizQuestionsEditArea.innerHTML = '';
            quizArray.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('p-3', 'border', 'rounded-md', 'bg-white', 'mb-3');
                questionDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-700 text-sm font-bold">Pertanyaan ${qIndex + 1}:</label>
                        <button class="remove-question-btn text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <input type="text" class="question-text-input shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2" value="${q.question}" placeholder="Teks Pertanyaan">
                    <div class="options-container space-y-2 mb-2">
                        <!-- Options will be added here -->
                    </div>
                    <button class="add-option-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-bold py-1 px-3 rounded-md w-full">Tambah Opsi</button>
                    <label class="block text-gray-700 text-sm font-bold mt-2">Jawaban Benar (indeks 0-based):</label>
                    <input type="number" class="correct-answer-input shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="${q.correct_answer_index}" min="0">
                `;
                quizQuestionsEditArea.appendChild(questionDiv);

                const optionsContainer = questionDiv.querySelector('.options-container');
                q.options.forEach((option, oIndex) => {
                    const optionInput = document.createElement('input');
                    optionInput.type = 'text';
                    optionInput.classList.add('option-input', 'shadow', 'appearance-none', 'border', 'rounded', 'w-full', 'py-1', 'px-2', 'text-gray-700', 'leading-tight', 'focus:outline-none', 'focus:shadow-outline');
                    optionInput.value = option;
                    optionInput.placeholder = `Opsi ${oIndex + 1}`;
                    optionsContainer.appendChild(optionInput);
                });

                // Event listeners for new elements
                questionDiv.querySelector('.remove-question-btn').addEventListener('click', () => {
                    quizArray.splice(qIndex, 1);
                    renderQuizEdit(quizArray); // Re-render to update indices
                });
                questionDiv.querySelector('.add-option-btn').addEventListener('click', () => {
                    q.options.push(''); // Add an empty option
                    renderQuizEdit(quizArray); // Re-render to show new option
                });
            });
        }

        // Add New Quiz Question
        addQuizQuestionBtn.addEventListener('click', () => {
            const subjectId = chapterEditForm.dataset.subjectId;
            const chapterId = chapterEditForm.dataset.chapterId;
            const chapter = appData.chapters[subjectId].find(c => c.id === chapterId);
            
            if (chapter) {
                chapter.quiz.push({ question: '', options: ['', '', ''], correct_answer_index: 0 }); // Default 3 options
                renderQuizEdit(chapter.quiz);
            }
        });

        // Save Chapter Changes
        saveChapterChangesBtn.addEventListener('click', async () => { // <<< FIX: Made async
            const subjectId = chapterEditForm.dataset.subjectId;
            const chapterId = chapterEditForm.dataset.chapterId;

            const chapter = appData.chapters[subjectId].find(c => c.id === chapterId);

            if (chapter) {
                chapter.title = editChapterTitle.value.trim();
                chapter.content_summary = editChapterSummary.value.trim();
                chapter.material_content = editMaterialContent.value;
                
                // Process the YouTube direct URL input and store only the ID
                const youtubeUrlInput = editVideoUrl.value.trim();
                chapter.video_url = getYouTubeVideoId(youtubeUrlInput); // Store only the video ID

                chapter.audio_url = editAudioUrl.value.trim(); // Save audio URL

                // Update quiz questions
                const updatedQuiz = [];
                Array.from(quizQuestionsEditArea.children).forEach(questionDiv => {
                    const questionText = questionDiv.querySelector('.question-text-input').value.trim();
                    const options = Array.from(questionDiv.querySelectorAll('.option-input')).map(input => input.value.trim());
                    const correctAnswerIndex = parseInt(questionDiv.querySelector('.correct-answer-input').value, 10);

                    if (questionText && options.some(opt => opt !== '')) { // Only add if question and at least one option exist
                        updatedQuiz.push({
                            question: questionText,
                            options: options.filter(opt => opt !== ''), // Filter out empty options
                            correct_answer_index: isNaN(correctAnswerIndex) ? 0 : correctAnswerIndex
                        });
                    }
                });
                chapter.quiz = updatedQuiz;

                const saveSuccess = await saveData(); // <<< FIX: Await save status

                if (saveSuccess) {
                    renderChapters(subjectId); // Re-render chapter list to show changes
                    authFeedback.textContent = 'Bab berhasil diperbarui dan tersimpan online!';
                    authFeedback.className = 'text-center text-green-600 font-bold mt-4';
                    chapterEditForm.classList.add('hidden');
                } else {
                    authFeedback.textContent = 'Gagal menyimpan perubahan bab secara online. Periksa Aturan Keamanan Firestore.';
                    authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                }
            }
        });

        // Delete Chapter
        deleteChapterBtn.addEventListener('click', async () => { // <<< FIX: Made async
            const subjectId = selectSubjectForChapters.value;
            const chapterId = selectChapterToEdit.value;

            if (!subjectId || !chapterId) {
                authFeedback.textContent = 'Pilih mata pelajaran dan bab untuk dihapus.';
                authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                return;
            }
            if (confirm('Apakah Anda yakin ingin menghapus bab ini?')) {
                appData.chapters[subjectId] = appData.chapters[subjectId].filter(c => c.id !== chapterId);
                
                const saveSuccess = await saveData(); // <<< FIX: Await save status

                if (saveSuccess) {
                    selectChapterToEdit.innerHTML = '<option value="">Pilih Bab</option>'; // Clear selected chapter
                    chapterEditForm.classList.add('hidden'); // Hide form
                    renderChapters(subjectId); // Re-render chapter list
                    authFeedback.textContent = 'Bab berhasil dihapus dan tersimpan online!';
                    authFeedback.className = 'text-center text-green-600 font-bold mt-4';
                } else {
                    authFeedback.textContent = 'Gagal menghapus bab secara online. Periksa Aturan Keamanan Firestore.';
                    authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                }
            }
        });

        // Add New Chapter (Now uses custom modal)
        addNewChapterBtn.addEventListener('click', () => {
            const subjectId = selectSubjectForChapters.value;
            console.log('Attempting to add new chapter. Subject ID:', subjectId); // Debug log
            if (!subjectId) {
                authFeedback.textContent = 'Pilih mata pelajaran terlebih dahulu untuk menambahkan bab baru.';
                authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                console.log('No subject selected.'); // Debug log
                return;
            }

            showCustomInputModal('Tambah Bab Baru', 'Masukkan judul bab baru...', async (newChapterTitle) => { // <<< FIX: Made async
                if (newChapterTitle && newChapterTitle.trim() !== '') {
                    // Unique ID generation: subject-title-timestamp
                    const newChapterId = `${subjectId}-${newChapterTitle.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, '')}-${Date.now()}`; 
                    
                    if (!appData.chapters[subjectId]) {
                        appData.chapters[subjectId] = [];
                    }

                    appData.chapters[subjectId].push({
                        id: newChapterId,
                        title: newChapterTitle.trim(),
                        content_summary: 'Ringkasan materi bab baru.',
                        material_content: '<p>Materi bab baru akan ditulis di sini.</p>',
                        video_url: '', // Stored as video ID now
                        audio_url: '', // Initialize new audio field
                        quiz: [
                            { question: 'Pertanyaan 1 kuis bab baru?', options: ['Opsi A', 'Opsi B', 'Opsi C'], correct_answer_index: 0 },
                            { question: 'Pertanyaan 2 kuis bab baru?', options: ['Opsi A', 'Opsi B', 'Opsi C'], correct_answer_index: 1 },
                            { question: 'Pertanyaan 3 kuis bab baru?', options: ['Opsi A', 'Opsi B', 'Opsi C'], correct_answer_index: 2 },
                            { question: 'Pertanyaan 4 kuis bab baru?', options: ['Opsi A', 'Opsi B', 'Opsi C'], correct_answer_index: 0 },
                            { question: 'Pertanyaan 5 kuis bab baru?', options: ['Opsi A', 'Opsi B', 'Opsi C'], correct_answer_index: 1 }
                        ]
                    });
                    
                    const saveSuccess = await saveData(); // <<< FIX: Await save status

                    if (saveSuccess) {
                        renderSettingsSubjectSelect(); // Refresh dropdowns
                        selectSubjectForChapters.value = subjectId; // Keep subject selected
                        selectSubjectForChapters.dispatchEvent(new Event('change')); // Trigger change to load new chapter
                        authFeedback.textContent = 'Bab baru berhasil ditambahkan dan tersimpan online!';
                        authFeedback.className = 'text-center text-green-600 font-bold mt-4';
                        renderChapters(subjectId); // Re-render main chapter list
                        console.log('New chapter added successfully:', newChapterId);
                        return true; // Close modal
                    } else {
                        authFeedback.textContent = 'Gagal menambah bab baru secara online. Periksa Aturan Keamanan Firestore.';
                        authFeedback.className = 'text-center text-red-600 font-bold mt-4';
                        // Revert the local change if save fails to avoid desync
                        appData.chapters[subjectId].pop();
                        return false; // Keep modal open or prompt user to retry
                    }

                } else {
                    customInputFeedback.textContent = 'Judul tidak boleh kosong.';
                    customInputFeedback.classList.remove('hidden');
                    console.log('New chapter creation cancelled or empty title.');
                    return false; // Keep modal open
                }
            });
        });

        // --- Custom Input Modal Logic (New!) ---
        function showCustomInputModal(title, placeholder, callback) {
            customInputTitle.textContent = title;
            customInputField.value = '';
            customInputField.placeholder = placeholder;
            customInputFeedback.classList.add('hidden'); // Hide previous feedback
            customInputCallback = callback; // Store the callback

            customInputModal.classList.add('active');
            customInputField.focus(); // Focus on the input field
        }

        function hideCustomInputModal() {
            customInputModal.classList.remove('active');
            customInputCallback = null; // Clear the callback
        }

        customInputCloseButton.addEventListener('click', hideCustomInputModal);
        customInputCancelBtn.addEventListener('click', hideCustomInputModal);

        customInputSubmitBtn.addEventListener('click', () => {
            const inputValue = customInputField.value.trim();
            if (customInputCallback) {
                // If callback returns true, close modal. Otherwise, keep open for correction.
                const shouldClose = customInputCallback(inputValue);
                if (shouldClose) {
                    hideCustomInputModal();
                }
            } else {
                hideCustomInputModal(); // Close if no callback set
            }
        });

        customInputField.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                customInputSubmitBtn.click();
            }
        });


        // --- Initialize the application ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>
